<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>两端差异-键盘行为优化 | Meteor</title>
    <meta name="description" content="欢迎来到我的个人页面">
    
    
    <link rel="preload" href="/MyBlog/assets/css/23.styles.cc84573a.css" as="style"><link rel="preload" href="/MyBlog/assets/js/app.19eb8d83.js" as="script"><link rel="preload" href="/MyBlog/assets/js/17.23dda7fa.js" as="script"><link rel="prefetch" href="/MyBlog/assets/js/12.53cafe37.js"><link rel="prefetch" href="/MyBlog/assets/js/1.38c1cab2.js"><link rel="prefetch" href="/MyBlog/assets/js/2.493d4717.js"><link rel="prefetch" href="/MyBlog/assets/js/3.fec61410.js"><link rel="prefetch" href="/MyBlog/assets/js/4.7b46e1a9.js"><link rel="prefetch" href="/MyBlog/assets/js/5.a8da7034.js"><link rel="prefetch" href="/MyBlog/assets/js/6.1afa3de3.js"><link rel="prefetch" href="/MyBlog/assets/js/7.bb628056.js"><link rel="prefetch" href="/MyBlog/assets/js/8.4320c542.js"><link rel="prefetch" href="/MyBlog/assets/js/9.ae9485eb.js"><link rel="prefetch" href="/MyBlog/assets/js/10.4f6f2f80.js"><link rel="prefetch" href="/MyBlog/assets/js/11.3dd0d6bb.js"><link rel="prefetch" href="/MyBlog/assets/js/13.4a7a2bd8.js"><link rel="prefetch" href="/MyBlog/assets/js/14.fd64b4ff.js"><link rel="prefetch" href="/MyBlog/assets/js/15.0aea93d5.js"><link rel="prefetch" href="/MyBlog/assets/js/16.205e0222.js"><link rel="prefetch" href="/MyBlog/assets/js/18.9a90913a.js"><link rel="prefetch" href="/MyBlog/assets/js/19.217ac63a.js"><link rel="prefetch" href="/MyBlog/assets/js/20.e5f657ab.js"><link rel="prefetch" href="/MyBlog/assets/js/21.a7e51597.js"><link rel="prefetch" href="/MyBlog/assets/js/22.4c47086b.js">
    <link rel="stylesheet" href="/MyBlog/assets/css/23.styles.cc84573a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/MyBlog/" class="home-link router-link-active"><!----><span class="site-name">
      Meteor
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><nav class="nav-links can-hide"><div class="nav-item"><a href="/MyBlog/" class="nav-link">主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">博客</span><span class="arrow right"></span></a><ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----><a href="https://github.com/MeteorOCC" target="_blank" rel="noopener noreferrer" class="nav-link external">
  正在动工,可先使用搜索栏搜索关键字寻找博文
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">github</span><span class="arrow right"></span></a><ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----><a href="https://github.com/MeteorOCC" target="_blank" rel="noopener noreferrer" class="nav-link external">
  并没有这一个选项quq
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><!----></nav></div></header><div class="sidebar-mask"></div><div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/MyBlog/" class="nav-link">主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">博客</span><span class="arrow right"></span></a><ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----><a href="https://github.com/MeteorOCC" target="_blank" rel="noopener noreferrer" class="nav-link external">
  正在动工,可先使用搜索栏搜索关键字寻找博文
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">github</span><span class="arrow right"></span></a><ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----><a href="https://github.com/MeteorOCC" target="_blank" rel="noopener noreferrer" class="nav-link external">
  并没有这一个选项quq
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><!----></nav><!----></div><div class="page"><div class="content"><h2 id="两端差异-键盘行为优化"><a href="#两端差异-键盘行为优化" aria-hidden="true" class="header-anchor">#</a> 两端差异-键盘行为优化</h2><blockquote><p>2018/9/12，惯例打开 Jira，看到一排排鲜红的 bug 列表，迷迷糊糊的我突然就吓醒了，点开查看，清一色的<code>软键盘遮挡表单</code>问题。在主流程通过测试后一些用户交互方面的东西被测试关注，于是这个问题彻底爆发。</p><p>请注意，项目技术选型为<code>Vue</code></p></blockquote><p>说起这个键盘差异，其实项目初期我就关注到了，但是当时主业务流程要紧而且产品跟 UI 并没有定义规范的交互流程，也就是说暂时是一个不 care 的点，就这么忽略过去了。但是现在项目末期到关注用户交互体验的时候，这个问题就变成了一道催命符，急待解决。</p><p>出现这种问题主要还是因为金融项目中有些 input 框需要调起自定义的安全键盘，需要 hack 安全键盘和普通 input 输入键盘之间的兼容问题，而在 Vue 中，V-for 的使用又是比较必要的，抬起键盘这个行为加上指令一次加在所有 input 上，那么这个事情做起来就更需要注意会不会导致出现奇怪的 bug。</p><h3 id="android-端："><a href="#android-端：" aria-hidden="true" class="header-anchor">#</a> Android 端：</h3><p>浏览器键盘像是一层<code>position:absoulte</code>的 div 覆盖在浏览器上面，当<code>表单类</code>元素获得焦点的时候弹出，<code>表单类</code>元素失去焦点的时候消失(用户也可以手动点击输入法一个向下的箭头让其消失)，点击空白区域也可让键盘自行消失，此时<code>表单类</code>元素也失去焦点。</p><h3 id="ios-端："><a href="#ios-端：" aria-hidden="true" class="header-anchor">#</a> IOS 端：</h3><p>浏览器键盘也是像<code>position:absoulte</code>的 div 覆盖在浏览器上面，但此时 Webview 会扩大一个浏览器键盘的高度，页面出现滚动条，在原生的层面上去获取当前点击的位置，计算出文档的高度，如果在设定的水平线上，那么就不做抬升操作，如果在水平线下，那就做抬升操作，抬升的高度和表单元素距离顶部的高度有关。</p><p>当<code>表单类</code>元素获得焦点时显示，<code>表单类</code>元素失去焦点的时候消失，<strong>点击空白区域时<code>表单类</code>元素不会失去焦点。</strong></p><p>如果原生需要做第三方键盘来代替浏览器键盘，那么你将会注意到：
①input focus 时如果同时调用第三方键盘，那么 IOS 原生无非就是拦截掉调出浏览器键盘事件然后给你上个自定义键盘。如果这么做的话，input 会得到焦点后马上失焦。所以最好不要用 focus 做什么事情。
② 根据 ①，我们在做这种自定义键盘调用的时候一般也是用<code>touch</code>或者<code>click</code>并且让 input 为<code>readonly</code>状态。此时因为 input 不会再获得焦点，IOS 端是不会帮你抬屏的，问题就是这里其实也隐藏了一个很大的坑：如果你自己通过样式的行为去做一个抬屏的的操作，单个输入框看上去一点问题都没有。但是输入框之间切换的话，IOS 自己的抬屏就会变得不正常。
③ 如果要在 IOS 做混合 APP 自定义键盘的兼容没有原生的协助，那么我建议前端们先把电脑扔出窗外先冷静冷静。</p><h3 id="总结："><a href="#总结：" aria-hidden="true" class="header-anchor">#</a> 总结：</h3><p>IOS 普通 input 唤出的键盘无需做过多兼容，本身已经有了很好的支持，只需要将点击空白区域时<code>表单类</code>元素失去焦点这个功能添加上即可。
IOS 端第三方键盘的抬屏处理建议让原生一起做了。苹果帮助普通用户获得更好的体验的时候，丝毫没有想到这对开发者会有什么影响：开发者想做一些定制行为的时候，总会遇到奇怪的问题。</p><p>Android 普通 input 调用则需要对 input 添加一个指令，该指令主要负责计算 input 位于页面的位置然后传回参数来确定是否抬屏，以达到类似 IOS 端的效果。</p><p>同时 Android 输入法内置的收起箭头无法触发 input 框的失焦事件，这个需要从原生层面上去解决，非 Web 端力所能及，无需过多纠结，对于自定义键盘的处理，Android 的原生同学可以选择做或者不做，不做嘛前端也能做，做嘛前端就省点力气。</p><h3 id="用于键盘生效时抬升键盘的全局指令："><a href="#用于键盘生效时抬升键盘的全局指令：" aria-hidden="true" class="header-anchor">#</a> 用于键盘生效时抬升键盘的全局指令：</h3><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">/**
 * v-input-positioning指定，用于解决软键盘遮挡input的问题，现在只在android中触发
 * 绑定该指令的组件，当其中的input取得焦点时会触发input-positioning事件，该事件将该元素应该上移的样式抛出来
 * 用户需要自行决定需要将该样式绑定到哪里
 * 失去焦点会抛出空字符串
 */</span>
Vue<span class="token punctuation">.</span><span class="token function">directive</span><span class="token punctuation">(</span><span class="token string">'input-positioning'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">bind</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> binding<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> oldVnode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 触发调整input位置的条件，现在只有安卓才触发</span>
    <span class="token keyword">function</span> <span class="token function">getVueInstance</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> vnode<span class="token punctuation">.</span>componentInstance <span class="token operator">||</span> vnode<span class="token punctuation">.</span>context
    <span class="token punctuation">}</span>
    <span class="token comment">// 取得input元素</span>
    <span class="token keyword">function</span> <span class="token function">getInputElement</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> el<span class="token punctuation">.</span>tagName <span class="token operator">===</span> <span class="token string">'INPUT'</span> <span class="token operator">?</span> el <span class="token punctuation">:</span> el<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'input'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 冒泡事件</span>
    <span class="token keyword">function</span> <span class="token function">executeHandler</span><span class="token punctuation">(</span>binding<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> style<span class="token punctuation">,</span> position<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> handler <span class="token operator">=</span> vnode<span class="token punctuation">.</span>context<span class="token punctuation">[</span>binding<span class="token punctuation">.</span>expression<span class="token punctuation">]</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">handler</span><span class="token punctuation">(</span>style<span class="token punctuation">,</span> position<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        binding<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>context<span class="token punctuation">,</span> style<span class="token punctuation">,</span> position<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 首次focus时取得元素的位置并记录</span>
    <span class="token keyword">function</span> <span class="token function">getInitPositionOfElement</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>el<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>position<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> componentElement <span class="token operator">=</span> vnode<span class="token punctuation">.</span>componentInstance <span class="token operator">?</span> vnode<span class="token punctuation">.</span>componentInstance<span class="token punctuation">.</span>$el <span class="token punctuation">:</span> el
        <span class="token comment">// 计算应该上移的高度,并保存数据，需要保证已经插入到文档中</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>componentElement<span class="token punctuation">.</span>offsetTop <span class="token operator">&amp;&amp;</span> componentElement<span class="token punctuation">.</span>offsetHeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          el<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>position <span class="token operator">=</span> componentElement<span class="token punctuation">.</span>offsetTop <span class="token operator">+</span> componentElement<span class="token punctuation">.</span>offsetHeight
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 有绑定表达式，但是却没有值的时候，就说明不需要触发事件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>binding<span class="token punctuation">.</span>expression <span class="token operator">&amp;&amp;</span> binding<span class="token punctuation">.</span>value <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> binding<span class="token punctuation">.</span>value <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
        <span class="token string">'v-input-positioning绑定表达式必须为一个函数以激活input自适应位置功能，'</span> <span class="token operator">+</span> <span class="token string">'或其值能转化为false从而禁用该功能'</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>binding<span class="token punctuation">.</span>expression <span class="token operator">||</span> <span class="token operator">!</span>binding<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> shouldTrigger <span class="token operator">=</span> <span class="token function">getVueInstance</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span><span class="token punctuation">.</span>$global<span class="token punctuation">.</span>userAgent<span class="token punctuation">.</span><span class="token constant">IS_ANDROID</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldTrigger<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> input <span class="token operator">=</span> <span class="token function">getInputElement</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span>

      <span class="token comment">// 给input添加事件，非password type的input框使用以下处理：</span>
      <span class="token comment">// 不需要对password type的input框单独处理的话去掉对type的判断即可。</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>input <span class="token operator">&amp;&amp;</span> input<span class="token punctuation">.</span>type <span class="token operator">!==</span> <span class="token string">'password'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 记录未适配时的位置</span>
        input<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'focus'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">getInitPositionOfElement</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>
          <span class="token keyword">let</span> top <span class="token operator">=</span> el<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>position <span class="token operator">-</span> window<span class="token punctuation">.</span>innerHeight <span class="token operator">*</span> <span class="token number">0.4</span>
          <span class="token keyword">let</span> style <span class="token operator">=</span> top <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token template-string"><span class="token string">`transform:translateY(-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>top<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px)`</span></span> <span class="token punctuation">:</span> <span class="token string">''</span>
          <span class="token function">executeHandler</span><span class="token punctuation">(</span>binding<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> style<span class="token punctuation">,</span> el<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>position<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        input<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'blur'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">executeHandler</span><span class="token punctuation">(</span>binding<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> el<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>position<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        input<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'keypress'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>key <span class="token operator">===</span> <span class="token string">'Enter'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">blur</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="ios-端点击空白区域-input-失焦函数"><a href="#ios-端点击空白区域-input-失焦函数" aria-hidden="true" class="header-anchor">#</a> IOS 端点击空白区域 input 失焦函数</h3><div class="language-javascript extra-class"><pre class="language-javascript"><code>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'app'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function-variable function">ontouchend</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">//this.$global.userAgent.IS_IOS是我项目中定义的判断设备端的字段，请根据项目情况自行设置</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$global<span class="token punctuation">.</span>userAgent<span class="token punctuation">.</span><span class="token constant">IS_IOS</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//CHILDRENROUTER是我项目中定义的router-view的统一ID，遍历其中的input并使它们全部失焦。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'CHILDRENROUTER'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'input'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      document
        <span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'CHILDRENROUTER'</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token string">'input'</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">blur</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="对安全键盘行为的全局指令："><a href="#对安全键盘行为的全局指令：" aria-hidden="true" class="header-anchor">#</a> 对安全键盘行为的全局指令：</h3><blockquote><p>首先说明一下 Android/IOS 端呼出自定义(安全)键盘时两端的差异。</p><ul><li>Android：Android 端在浏览器存在自定义键盘时不会帮开发者处理 input 的聚焦与失焦，也就是说如果在 input 框聚焦的同时含有自定义键盘，那么此时界面上将存在两个键盘，而因我项目的原生处理事情效率不高，所以还是决定自己来做这个兼容，这个时候就要在 input 框得到焦点时让其失焦，需要抬屏再根据前面的指令来做兼容。</li><li>IOS：IOS 端在浏览器存在自定义键盘时会自行将 input 失焦，也就是说自定义键盘或者浏览器键盘只能同时存在一个。抬屏问题无需兼容，智能抬屏依然生效。</li><li>共同的问题：本质上都是 input 失焦才能呼出这个自定义键盘，所以光标无法生效。但个人不建议用其它元素的边框动画来做一个假的光标处理，除非封装成组件。</li></ul></blockquote><div class="language-javascript extra-class"><pre class="language-javascript"><code>Vue<span class="token punctuation">.</span><span class="token function">directive</span><span class="token punctuation">(</span><span class="token string">'password-keyboard'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">bind</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> binding<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">function</span> <span class="token function">getVueInstance</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> vnode<span class="token punctuation">.</span>componentInstance <span class="token operator">||</span> vnode<span class="token punctuation">.</span>context
    <span class="token punctuation">}</span>
    <span class="token comment">// 取得input元素</span>
    <span class="token keyword">function</span> <span class="token function">getInputElement</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>tagName <span class="token operator">===</span> <span class="token string">'INPUT'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> el
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'password-keyboard指令只能绑定在input元素上,当type=&quot;password&quot;时生效'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 首次focus时取得元素的位置并记录</span>
    <span class="token keyword">function</span> <span class="token function">getInitPositionOfElement</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>el<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>position<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> componentElement <span class="token operator">=</span> vnode<span class="token punctuation">.</span>componentInstance <span class="token operator">?</span> vnode<span class="token punctuation">.</span>componentInstance<span class="token punctuation">.</span>$el <span class="token punctuation">:</span> el
        <span class="token comment">// 计算应该上移的高度,并保存数据，需要保证已经插入到文档中</span>
        <span class="token keyword">let</span> rect <span class="token operator">=</span> componentElement<span class="token punctuation">.</span><span class="token function">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        el<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>position <span class="token operator">=</span> rect<span class="token punctuation">.</span>top <span class="token operator">+</span> rect<span class="token punctuation">.</span>height
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 冒泡事件</span>
    <span class="token keyword">function</span> <span class="token function">executeHandler</span><span class="token punctuation">(</span>binding<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> handler <span class="token operator">=</span> vnode<span class="token punctuation">.</span>context<span class="token punctuation">[</span>binding<span class="token punctuation">.</span>expression<span class="token punctuation">]</span>
      <span class="token comment">//安全键盘状态(升起true/隐藏false，默认为false)</span>
      <span class="token keyword">let</span> keyBoardState <span class="token operator">=</span> <span class="token boolean">false</span>
      <span class="token comment">//安全键盘输入的内容对象，无值时为空</span>
      <span class="token keyword">let</span> keyBoardInputObject <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token comment">//只有安卓需要抬屏上的处理</span>
      <span class="token keyword">let</span> styleObject <span class="token operator">=</span> <span class="token function">getVueInstance</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span><span class="token punctuation">.</span>$global<span class="token punctuation">.</span>userAgent<span class="token punctuation">.</span><span class="token constant">IS_ANDROID</span>
        <span class="token operator">?</span> <span class="token punctuation">{</span>
            top<span class="token punctuation">:</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>position <span class="token operator">-</span> window<span class="token punctuation">.</span>screen<span class="token punctuation">.</span>availHeight <span class="token operator">*</span> <span class="token number">0.45</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> styleObject<span class="token punctuation">.</span>top <span class="token operator">!==</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        styleObject<span class="token punctuation">.</span>style <span class="token operator">=</span> styleObject<span class="token punctuation">.</span>top <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token template-string"><span class="token string">`transform:translateY(-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>styleObject<span class="token punctuation">.</span>top<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px)`</span></span> <span class="token punctuation">:</span> <span class="token string">''</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//安全键盘升起时的回调</span>
        <span class="token function">getVueInstance</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span><span class="token punctuation">.</span>$native<span class="token punctuation">.</span><span class="token function">registerKeyBoardUp</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          keyBoardState <span class="token operator">=</span> <span class="token boolean">true</span>
          <span class="token function">handler</span><span class="token punctuation">(</span>keyBoardState<span class="token punctuation">,</span> keyBoardInputObject<span class="token punctuation">,</span> styleObject<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token comment">//安全键盘隐藏时的回调</span>
        <span class="token function">getVueInstance</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span><span class="token punctuation">.</span>$native<span class="token punctuation">.</span><span class="token function">registerKeyBoardDown</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          keyBoardState <span class="token operator">=</span> <span class="token boolean">false</span>
          <span class="token function">handler</span><span class="token punctuation">(</span>keyBoardState<span class="token punctuation">,</span> keyBoardInputObject<span class="token punctuation">,</span> styleObject<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token comment">//安全键盘输入时的回调</span>
        <span class="token function">getVueInstance</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span><span class="token punctuation">.</span>$native<span class="token punctuation">.</span><span class="token function">registerKeyInputs</span><span class="token punctuation">(</span>e <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          keyBoardInputObject <span class="token operator">=</span> <span class="token punctuation">{</span>
            unrealPsw<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span><span class="token function">parseInt</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>keylength<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'●'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            encryptionPsw<span class="token punctuation">:</span> e<span class="token punctuation">.</span>pswRSA<span class="token punctuation">,</span>
            realPsw<span class="token punctuation">:</span> e<span class="token punctuation">.</span>password
          <span class="token punctuation">}</span>
          <span class="token function">handler</span><span class="token punctuation">(</span>keyBoardState<span class="token punctuation">,</span> keyBoardInputObject<span class="token punctuation">,</span> styleObject<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        binding<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>context<span class="token punctuation">,</span> keyBoardState<span class="token punctuation">,</span> keyBoardInputObject<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> input <span class="token operator">=</span> <span class="token function">getInputElement</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span>
    <span class="token comment">//$global.userAgent.IS_FINCHAT字段判断是否在我们的原生环境内，如果在纯页端是无法访问到原生的方法的，这个时候就不需要做其他的事情了，input直接正常使用即可。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>input <span class="token operator">&amp;&amp;</span> input<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'password'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">getVueInstance</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span><span class="token punctuation">.</span>$global<span class="token punctuation">.</span>userAgent<span class="token punctuation">.</span><span class="token constant">IS_FINCHAT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//在自家的原生环境下，聚焦后判断是否为Android端，如果是Android端聚焦后马上失焦</span>
      <span class="token comment">//如果是IOS端则可以在不做失焦(实际上WKwebview已经帮你做了)的情况下直接调用安全键盘</span>
      input<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'focus'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">getInitPositionOfElement</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getVueInstance</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span><span class="token punctuation">.</span>$global<span class="token punctuation">.</span>userAgent<span class="token punctuation">.</span><span class="token constant">IS_ANDROID</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          document<span class="token punctuation">.</span>activeElement<span class="token punctuation">.</span><span class="token function">blur</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//调用自定义(安全)键盘函数</span>
        <span class="token function">getVueInstance</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span>
          <span class="token punctuation">.</span>$native<span class="token punctuation">.</span><span class="token function">openLoginKeyboard</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>data <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span>error <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token comment">//聚焦时冒泡事件</span>
        <span class="token function">executeHandler</span><span class="token punctuation">(</span>binding<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="感想："><a href="#感想：" aria-hidden="true" class="header-anchor">#</a> 感想：</h3><p>其实有些东西，本来是应该两端开发人员帮页端做好的/想好的东西，让纯 Web 端做兼容，是一件很不厚道的事情。。</p><p>因为 Web 端做这类兼容容易留下大量 hack 过的代码，以后别人想迭代和升级都脑壳疼，而且也不完美。</p><p>现在使用 input 元素，简单的 HTML 代码：</p><div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token style-attr language-css"><span class="token attr-name"> <span class="token attr-name">style</span></span><span class="token punctuation">=&quot;</span><span class="token attr-value"><span class="token property">transition</span><span class="token punctuation">:</span> all .3s ease</span><span class="token punctuation">&quot;</span></span>
         <span class="token attr-name">:</span><span class="token style-attr language-css"><span class="token attr-name"><span class="token attr-name">style</span></span><span class="token punctuation">=&quot;</span><span class="token attr-value">style</span><span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>password<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">v-input-positioning</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>test<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">v-model</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>pd<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">v-password-keyboard</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>keyboard<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>然后自己在页面内根据不同的需求定义一下指令绑定的函数</p><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">test</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>style <span class="token operator">=</span> e
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token function">keyboard</span> <span class="token punctuation">(</span>keyBoardState<span class="token punctuation">,</span> keyBoardInputObject<span class="token punctuation">,</span> styleObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>pd <span class="token operator">=</span> <span class="token keyword">typeof</span> <span class="token punctuation">(</span>keyBoardInputObject<span class="token punctuation">.</span>unrealPsw<span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token string">'undefined'</span> <span class="token operator">?</span> keyBoardInputObject<span class="token punctuation">.</span>unrealPsw <span class="token punctuation">:</span> <span class="token string">''</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> <span class="token punctuation">(</span>styleObject<span class="token punctuation">.</span>style<span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>style <span class="token operator">=</span> keyBoardState <span class="token operator">?</span> styleObject<span class="token punctuation">.</span>style <span class="token punctuation">:</span> <span class="token string">''</span>
      <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其实 test 和 keyboard 是可以整个到一起的，两个指令公用一个函数。</p><p>彻底一点来做，抬屏这件事情可以让指令把传回的 style 直接附加给公共容器 div 元素的 style，这样就不用在每个 vue 文件内都对自己的 container 做传 style 处理了。</p><p>后续可以直接对这种 input 封装成组件，test 函数和 keyboard 函数回传的东西统一通过$emit 到相同的事件上给父组件，这样就更好，同时还可以定制它们在项目中的行为。</p></div><div class="page-edit"><!----><!----></div><!----></div></div></div>
    <script src="/MyBlog/assets/js/17.23dda7fa.js" defer></script><script src="/MyBlog/assets/js/app.19eb8d83.js" defer></script>
  </body>
</html>
