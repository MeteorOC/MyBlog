<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>从头开始撸一个适用于自己项目的axios封装 | Meteor</title>
    <meta name="description" content="欢迎来到我的个人页面">
    
    
    <link rel="preload" href="/MyBlog/assets/css/23.styles.cc84573a.css" as="style"><link rel="preload" href="/MyBlog/assets/js/app.19eb8d83.js" as="script"><link rel="preload" href="/MyBlog/assets/js/1.38c1cab2.js" as="script"><link rel="prefetch" href="/MyBlog/assets/js/12.53cafe37.js"><link rel="prefetch" href="/MyBlog/assets/js/2.493d4717.js"><link rel="prefetch" href="/MyBlog/assets/js/3.fec61410.js"><link rel="prefetch" href="/MyBlog/assets/js/4.7b46e1a9.js"><link rel="prefetch" href="/MyBlog/assets/js/5.a8da7034.js"><link rel="prefetch" href="/MyBlog/assets/js/6.1afa3de3.js"><link rel="prefetch" href="/MyBlog/assets/js/7.bb628056.js"><link rel="prefetch" href="/MyBlog/assets/js/8.4320c542.js"><link rel="prefetch" href="/MyBlog/assets/js/9.ae9485eb.js"><link rel="prefetch" href="/MyBlog/assets/js/10.4f6f2f80.js"><link rel="prefetch" href="/MyBlog/assets/js/11.3dd0d6bb.js"><link rel="prefetch" href="/MyBlog/assets/js/13.4a7a2bd8.js"><link rel="prefetch" href="/MyBlog/assets/js/14.fd64b4ff.js"><link rel="prefetch" href="/MyBlog/assets/js/15.0aea93d5.js"><link rel="prefetch" href="/MyBlog/assets/js/16.205e0222.js"><link rel="prefetch" href="/MyBlog/assets/js/17.23dda7fa.js"><link rel="prefetch" href="/MyBlog/assets/js/18.9a90913a.js"><link rel="prefetch" href="/MyBlog/assets/js/19.217ac63a.js"><link rel="prefetch" href="/MyBlog/assets/js/20.e5f657ab.js"><link rel="prefetch" href="/MyBlog/assets/js/21.a7e51597.js"><link rel="prefetch" href="/MyBlog/assets/js/22.4c47086b.js">
    <link rel="stylesheet" href="/MyBlog/assets/css/23.styles.cc84573a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/MyBlog/" class="home-link router-link-active"><!----><span class="site-name">
      Meteor
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><nav class="nav-links can-hide"><div class="nav-item"><a href="/MyBlog/" class="nav-link">主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">博客</span><span class="arrow right"></span></a><ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----><a href="https://github.com/MeteorOCC" target="_blank" rel="noopener noreferrer" class="nav-link external">
  正在动工,可先使用搜索栏搜索关键字寻找博文
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">github</span><span class="arrow right"></span></a><ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----><a href="https://github.com/MeteorOCC" target="_blank" rel="noopener noreferrer" class="nav-link external">
  并没有这一个选项quq
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><!----></nav></div></header><div class="sidebar-mask"></div><div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/MyBlog/" class="nav-link">主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">博客</span><span class="arrow right"></span></a><ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----><a href="https://github.com/MeteorOCC" target="_blank" rel="noopener noreferrer" class="nav-link external">
  正在动工,可先使用搜索栏搜索关键字寻找博文
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">github</span><span class="arrow right"></span></a><ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----><a href="https://github.com/MeteorOCC" target="_blank" rel="noopener noreferrer" class="nav-link external">
  并没有这一个选项quq
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><!----></nav><!----></div><div class="page"><div class="content"><h1 id="从头开始撸一个适用于自己项目的axios封装"><a href="#从头开始撸一个适用于自己项目的axios封装" aria-hidden="true" class="header-anchor">#</a> 从头开始撸一个适用于自己项目的axios封装</h1><h2 id="_1-明确封装内容"><a href="#_1-明确封装内容" aria-hidden="true" class="header-anchor">#</a> 1.明确封装内容</h2><ul><li>对于每一个请求都会有一个true/false值记录其是否在进行中</li><li>错误跟踪</li><li>服务端传回的code码有对应的前端提示语句</li><li>对于正在进行的请求有重复校验，重复请求将会被取消</li><li>对应各种错误状态可以进行额外处理</li></ul><h2 id="_2-基本的封装"><a href="#_2-基本的封装" aria-hidden="true" class="header-anchor">#</a> 2.基本的封装</h2><p>首先我们仅仅是在axios的基础上封装我们需要的功能，调用的API应该是与axios保持一致的。</p><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">'axios'</span>
<span class="token keyword">class</span> <span class="token class-name">AxiosPackage</span> <span class="token punctuation">{</span>
  <span class="token keyword">get</span> <span class="token keyword">package</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$http
  <span class="token punctuation">}</span>
  <span class="token function">constructor</span> <span class="token punctuation">(</span>config<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//设置axios.defaults</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setAxiosDefault</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>
    <span class="token comment">//封装axios</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">packageAxios</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//使用拦截器</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">interceptors</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 封装axios请求</span>
  <span class="token function">packageAxios</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>requestArray <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">$http</span> <span class="token operator">=</span> config <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">axios</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>data <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> data
      <span class="token punctuation">}</span><span class="token punctuation">,</span> error <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> method <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'delete'</span><span class="token punctuation">,</span> <span class="token string">'get'</span><span class="token punctuation">,</span> <span class="token string">'head'</span><span class="token punctuation">,</span> <span class="token string">'options'</span><span class="token punctuation">,</span> <span class="token string">'post'</span><span class="token punctuation">,</span> <span class="token string">'put'</span><span class="token punctuation">,</span> <span class="token string">'patch'</span><span class="token punctuation">]</span>
    method<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>item <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">packageMethods</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 封装axios对应的请求方法</span>
  <span class="token function">packageMethods</span> <span class="token punctuation">(</span>method<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$http<span class="token punctuation">[</span>method<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> arguments<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">2</span> <span class="token operator">?</span> <span class="token function">axios</span><span class="token punctuation">(</span><span class="token punctuation">{</span> url<span class="token punctuation">:</span> arguments<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> method<span class="token punctuation">:</span> method<span class="token punctuation">,</span> data<span class="token punctuation">:</span> arguments<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">...</span>arguments<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token function">axios</span><span class="token punctuation">(</span><span class="token punctuation">{</span> url<span class="token punctuation">:</span> arguments<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> method<span class="token punctuation">:</span> method<span class="token punctuation">,</span> <span class="token operator">...</span>arguments<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>是不是发现缺少了些什么？我们还缺少拦截器interceptors和axios.defaults配置，下面开始对axios.defaults进行设置。</p><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">setAxiosDefault</span> <span class="token punctuation">(</span>config<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>config <span class="token operator">=</span> config
    Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>item <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> config<span class="token punctuation">[</span>item<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>config<span class="token punctuation">[</span>item<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>items <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>axios<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            axios<span class="token punctuation">.</span>defaults<span class="token punctuation">[</span>item<span class="token punctuation">]</span> <span class="token operator">=</span> config<span class="token punctuation">[</span>item<span class="token punctuation">]</span>
          <span class="token punctuation">}</span>
          axios<span class="token punctuation">.</span>defaults<span class="token punctuation">[</span>item<span class="token punctuation">]</span><span class="token punctuation">[</span>items<span class="token punctuation">]</span> <span class="token operator">=</span> config<span class="token punctuation">[</span>item<span class="token punctuation">]</span><span class="token punctuation">[</span>items<span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        axios<span class="token punctuation">.</span>defaults<span class="token punctuation">[</span>item<span class="token punctuation">]</span> <span class="token operator">=</span> config<span class="token punctuation">[</span>item<span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">//实际上就是在做axios.defaults.xx = xxx这样的操作</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>在constructor中，我们选择了config默认配置作为参数，也就是说在调用这个构造函数时，我们将config传入，那么在setAxiosDefault(config)中<code>config</code>即为传入的config</p></blockquote><p>至此，一个简单的axios封装就完成了</p><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> <span class="token constant">HTTP</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AxiosPackage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  timeout<span class="token punctuation">:</span> <span class="token number">10000</span><span class="token punctuation">,</span>
  headers<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    post<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token string">'Content-Type'</span><span class="token punctuation">:</span> <span class="token string">'application/x-www-form-urlencoded'</span><span class="token punctuation">,</span>
      <span class="token constant">IDENTIFY</span><span class="token punctuation">:</span> <span class="token string">'OACCOUNT_WEB'</span> <span class="token comment">//博主的项目特有，无需关注</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> $http <span class="token operator">=</span> <span class="token constant">HTTP</span><span class="token punctuation">.</span>$http
</code></pre></div><h3 id="_3-取消重复请求及获知请求状态"><a href="#_3-取消重复请求及获知请求状态" aria-hidden="true" class="header-anchor">#</a> 3.取消重复请求及获知请求状态</h3><p>当然，光有上面这些还不够，我们实际使用的过程中，肯定有很多想在request/response的过程中需要控制的内容，比如说对重复请求的控制，想要在项目中知道是否对用户显示该请求loading gif。</p><p>在packageAxios、packageMethods、interceptors、handleRequestArray函数中，我们进行如下处理:</p><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 封装axios请求</span>
<span class="token function">packageAxios</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>requestArray <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">$http</span> <span class="token operator">=</span> config <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>requestArray<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> error <span class="token operator">=</span> <span class="token string">'取消重复请求'</span>
            <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token operator">...</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>requestProcessObj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 封装axios对应的请求方法</span>
<span class="token function">packageMethods</span> <span class="token punctuation">(</span>method<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$http<span class="token punctuation">[</span>method<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>requestArray<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>arguments<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> error <span class="token operator">=</span> <span class="token string">'取消重复请求'</span>
        <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
     <span class="token operator">...</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 对请求队列及请求对应的状态进行处理</span>
<span class="token function">handleRequestArray</span> <span class="token punctuation">(</span>config<span class="token punctuation">,</span> mode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 请求时，requestArray push该请求url</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">===</span> <span class="token string">'request'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>requestArray<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>$http<span class="token punctuation">.</span>requestProcessObj<span class="token punctuation">[</span>config<span class="token punctuation">.</span>url<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// error或者response时，requestArray删除该请求的url</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>requestArray<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>url<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>requestArray<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>requestArray<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>requestArray <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>$http<span class="token punctuation">.</span>requestProcessObj<span class="token punctuation">[</span>config<span class="token punctuation">.</span>url<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 在请求或响应被 then 或 catch 处理前拦截它们</span>
<span class="token function">interceptors</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// axios请求拦截器</span>
    axios<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>config <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleRequestArray</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> <span class="token string">'request'</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> config
    <span class="token punctuation">}</span><span class="token punctuation">,</span> error <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleRequestArray</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>config<span class="token punctuation">,</span> <span class="token string">'error'</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// axios响应拦截器</span>
    axios<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>response <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleRequestArray</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>config<span class="token punctuation">,</span> <span class="token string">'response'</span><span class="token punctuation">)</span>
      <span class="token comment">// 未知异常状态直接回传response</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>data <span class="token operator">&amp;&amp;</span> response<span class="token punctuation">.</span>data<span class="token punctuation">.</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token function">Error</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 成功则直接回传response或者是config中定义的response</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>code<span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>data<span class="token punctuation">.</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> response
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> error <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleRequestArray</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>config <span class="token operator">||</span> error<span class="token punctuation">.</span>response<span class="token punctuation">.</span>config <span class="token operator">||</span> error<span class="token punctuation">,</span> <span class="token string">'error'</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>ok，这样对重复请求的控制及通过<code>this.requestProcessObj[url]</code>获知请求状态的封装就完成了。</p><h3 id="_4-根据后端自定义的错误码进行处理"><a href="#_4-根据后端自定义的错误码进行处理" aria-hidden="true" class="header-anchor">#</a> 4.根据后端自定义的错误码进行处理</h3><p>在博主的项目中，后端对错误业务的处理会有自己的一套code码，在请求的时候statusCode返回始终是200，这样我们上述的封装肯定是无法进入到Promise.reject中。而且错误回来之后需要怎么提示用户呢？（博主使用mint-ui中的toast提示用户）</p><blockquote><p>博主思索了一会还是决定将hint和code对应情况扔进defaultConfig中</p><div class="language-javascript extra-class"><pre class="language-javascript"><code>defaultConfig<span class="token punctuation">:</span><span class="token punctuation">{</span>
  <span class="token operator">...</span>
  code<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token constant">SUCCESS</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'0'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">'NEED_LOGIN'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'10'</span><span class="token punctuation">,</span> <span class="token string">'11'</span><span class="token punctuation">,</span> <span class="token string">'12'</span><span class="token punctuation">,</span> <span class="token string">'13'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">//需要登录</span>
    <span class="token string">'SERVER_ERROR'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'900'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">//系统错误</span>
    <span class="token string">'NEED_CERTIFICATE'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'90001'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">//需要凭证</span>
    <span class="token string">'NO_PERMISSION'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'90003'</span><span class="token punctuation">]</span> <span class="token comment">//没有权限</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  hint<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">'10'</span><span class="token punctuation">:</span> <span class="token string">'登录超时，请重新登录'</span><span class="token punctuation">,</span>
    <span class="token string">'11'</span><span class="token punctuation">:</span> <span class="token string">'请登录后访问该页面'</span><span class="token punctuation">,</span>
    <span class="token string">'12'</span><span class="token punctuation">:</span> <span class="token string">'长时间未操作，请重新登录'</span><span class="token punctuation">,</span>
    <span class="token string">'900'</span><span class="token punctuation">:</span> <span class="token string">'服务器异常，请稍后重试'</span><span class="token punctuation">,</span>
    <span class="token string">'90001'</span><span class="token punctuation">:</span> <span class="token string">'服务器异常，请稍后重试'</span><span class="token punctuation">,</span>
    <span class="token string">'90003'</span><span class="token punctuation">:</span> <span class="token string">'您暂无权限访问，请联系管理员'</span><span class="token punctuation">,</span>
    <span class="token string">'default'</span><span class="token punctuation">:</span> <span class="token string">'服务器异常，请稍后重试'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>关于提示，博主琢磨着在各种项目中通用，其他项目中不一定使用到这个toast，所以也是扔到了defaultConfig中，作为配置使用。</p><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> toast <span class="token keyword">from</span> <span class="token string">'./toast'</span>
deafultConfig<span class="token punctuation">:</span><span class="token punctuation">{</span>
    <span class="token operator">...</span><span class="token punctuation">.</span>
    toast<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> message<span class="token punctuation">,</span> iconClass <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">toast</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          message<span class="token punctuation">:</span> message<span class="token punctuation">,</span>
          iconClass<span class="token punctuation">:</span> iconClass <span class="token operator">||</span> <span class="token string">''</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></blockquote><p>对这种情况我们就需要进行一定的处理</p><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 错误生成</span>
  <span class="token function">createError</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> message<span class="token punctuation">,</span> response <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> error <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>
    error<span class="token punctuation">.</span>response <span class="token operator">=</span> response
    <span class="token keyword">return</span> error
  <span class="token punctuation">}</span>
<span class="token comment">// 创建提示（错误、警告、成功)</span>
  <span class="token function">createTips</span> <span class="token punctuation">(</span>message<span class="token punctuation">,</span> iconClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//相对于mint-ui原版的toast，我是直接截取下来做了改动(新冒泡会直接取消掉旧冒泡，message可以传html、icon改为淘宝iconfont的svg引用方式iconClass)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span><span class="token function">toast</span><span class="token punctuation">(</span><span class="token punctuation">{</span> message<span class="token punctuation">,</span> iconClass <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token comment">// 在请求或响应被 then 或 catch 处理前拦截它们</span>
  <span class="token function">interceptors</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span><span class="token punctuation">.</span> <span class="token comment">//request拦截，这里忽略，上文有</span>
    axios<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>response <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 未知异常状态直接回传response</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>data <span class="token operator">&amp;&amp;</span> response<span class="token punctuation">.</span>data<span class="token punctuation">.</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createError</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          response
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 成功则直接回传response或者是config中定义的response</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>code<span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>data<span class="token punctuation">.</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> response
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>code<span class="token punctuation">[</span><span class="token string">'NEED_LOGIN'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>data<span class="token punctuation">.</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 需要登录时抛出登录语句且直接跳进登录页</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">JumpLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//跳转到登录页面所需函数，自行调整，本文不提供</span>
        <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createError</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
           <span class="token comment">//关于后端自定义code，博主项目中后端固定传在response.data.code中，这算是一个定制性很强的东西，本应该作为配置项在defaultConfig中，不过这次没有抽取出来</span>
          message<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>hint<span class="token punctuation">[</span>response<span class="token punctuation">.</span>data<span class="token punctuation">.</span>code<span class="token punctuation">]</span><span class="token punctuation">,</span>
          response
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleRequestArray</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>config <span class="token operator">||</span> error<span class="token punctuation">.</span>response<span class="token punctuation">.</span>config <span class="token operator">||</span> error<span class="token punctuation">,</span> <span class="token string">'error'</span><span class="token punctuation">)</span>
        <span class="token comment">// 出现错误时抛出异常</span>
        <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>
          <span class="token comment">//关于错误message，博主项目中后端固定传在response.data.message中，这算是一个定制性很强的东西，本应该作为配置项在defaultConfig中，不过这次没有抽取出来。</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createError</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            message<span class="token punctuation">:</span> response<span class="token punctuation">.</span>data<span class="token punctuation">.</span>message <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>hint<span class="token punctuation">[</span><span class="token string">'default'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            response
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> error <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleRequestArray</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>config <span class="token operator">||</span> error<span class="token punctuation">.</span>response<span class="token punctuation">.</span>config <span class="token operator">||</span> error<span class="token punctuation">,</span> <span class="token string">'error'</span><span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createTips</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
      <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>至此，对后端自定义错误code码的处理完成</p><h3 id="_5-提取config"><a href="#_5-提取config" aria-hidden="true" class="header-anchor">#</a> 5.提取config</h3><p>博主是将axios.defaults的配置抽取到一个config.js的文件中</p><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> toast <span class="token keyword">from</span> <span class="token string">'@/components/toast'</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  timeout<span class="token punctuation">:</span> <span class="token number">10000</span><span class="token punctuation">,</span>
  headers<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    post<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token string">'Content-Type'</span><span class="token punctuation">:</span> <span class="token string">'application/x-www-form-urlencoded'</span><span class="token punctuation">,</span>
      <span class="token constant">IDENTIFY</span><span class="token punctuation">:</span> <span class="token string">'OACCOUNT_WEB'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  responseReturn<span class="token punctuation">:</span> response <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> response<span class="token punctuation">.</span>data<span class="token punctuation">.</span>data
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  code<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token constant">SUCCESS</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'0'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">'NEED_LOGIN'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'10'</span><span class="token punctuation">,</span> <span class="token string">'11'</span><span class="token punctuation">,</span> <span class="token string">'12'</span><span class="token punctuation">,</span> <span class="token string">'13'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">'SERVER_ERROR'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'900'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">'NEED_CERTIFICATE'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'90001'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">'NO_PERMISSION'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'90003'</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  hint<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">'10'</span><span class="token punctuation">:</span> <span class="token string">'登录超时，请重新登录'</span><span class="token punctuation">,</span>
    <span class="token string">'11'</span><span class="token punctuation">:</span> <span class="token string">'请登录后访问该页面'</span><span class="token punctuation">,</span>
    <span class="token string">'12'</span><span class="token punctuation">:</span> <span class="token string">'长时间未操作，请重新登录'</span><span class="token punctuation">,</span>
    <span class="token string">'900'</span><span class="token punctuation">:</span> <span class="token string">'服务器异常，请稍后重试'</span><span class="token punctuation">,</span>
    <span class="token string">'90001'</span><span class="token punctuation">:</span> <span class="token string">'服务器异常，请稍后重试'</span><span class="token punctuation">,</span>
    <span class="token string">'90003'</span><span class="token punctuation">:</span> <span class="token string">'您暂无权限访问，请联系管理员'</span><span class="token punctuation">,</span>
    <span class="token string">'default'</span><span class="token punctuation">:</span> <span class="token string">'服务器异常，请稍后重试'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  toast<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> message<span class="token punctuation">,</span> iconClass <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">toast</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      message<span class="token punctuation">:</span> message<span class="token punctuation">,</span>
      iconClass<span class="token punctuation">:</span> iconClass <span class="token operator">||</span> <span class="token string">''</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>调用</p><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> defaultConfig <span class="token keyword">from</span> <span class="token string">'./config'</span>
<span class="token keyword">let</span> <span class="token constant">HTTP</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AxiosPackage</span><span class="token punctuation">(</span>defaultConfig<span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> $http <span class="token operator">=</span> <span class="token constant">HTTP</span><span class="token punctuation">.</span>$http
</code></pre></div></div><div class="page-edit"><!----><!----></div><!----></div></div></div>
    <script src="/MyBlog/assets/js/1.38c1cab2.js" defer></script><script src="/MyBlog/assets/js/app.19eb8d83.js" defer></script>
  </body>
</html>
